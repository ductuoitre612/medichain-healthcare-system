<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MediChain - Hệ thống Y tế Blockchain</title>

    <!-- CSS -->
    <link rel="stylesheet" href="/frontend/css/common.css" />
    <link rel="stylesheet" href="/frontend/css/landing.css" />
    <link rel="stylesheet" href="/frontend/css/responsive.css" />

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Sui Wallet Standard -->
    <script src="https://unpkg.com/@mysten/wallet-standard@latest/dist/index.umd.js"></script>
  </head>
  <body class="landing-page">
    <div class="landing-container">
      <!-- Hero Section -->
      <div class="hero-section">
        <div class="hero-logo">
          <div class="logo-icon">
            <i class="fas fa-shield-heart"></i>
          </div>
          <h1>MediChain</h1>
          <p class="hero-tagline">Hệ thống Quản lý Y tế trên Blockchain Sui</p>
        </div>

        <p class="hero-description">
          MediChain sử dụng công nghệ blockchain để bảo vệ dữ liệu y tế của bạn,
          đảm bảo tính riêng tư, minh bạch và quyền sở hữu dữ liệu. Tất cả hồ sơ
          được mã hóa và lưu trữ an toàn trên mạng phi tập trung.
        </p>
      </div>

      <!-- Features Grid -->
      <div class="features-grid">
        <div class="feature-card">
          <div class="feature-icon medical-record">
            <i class="fas fa-file-medical"></i>
          </div>
          <h3>Bệnh án điện tử</h3>
          <p>
            Lưu trữ và quản lý bệnh án một cách an toàn trên blockchain với khả
            năng truy xuất minh bạch.
          </p>
        </div>

        <div class="feature-card">
          <div class="feature-icon prescription">
            <i class="fas fa-prescription-bottle-medical"></i>
          </div>
          <h3>Đơn thuốc số</h3>
          <p>
            Kê đơn thuốc không thể giả mạo, theo dõi toàn trình sử dụng thuốc và
            hạn sử dụng.
          </p>
        </div>

        <div class="feature-card">
          <div class="feature-icon appointment">
            <i class="fas fa-calendar-check"></i>
          </div>
          <h3>Lịch hẹn thông minh</h3>
          <p>
            Quản lý lịch hẹn khám bệnh, nhắc nhở tự động và xác nhận qua
            blockchain.
          </p>
        </div>

        <div class="feature-card">
          <div class="feature-icon share">
            <i class="fas fa-share-alt"></i>
          </div>
          <h3>Chia sẻ có kiểm soát</h3>
          <p>
            Chia sẻ hồ sơ y tế với bác sĩ mà bạn tin tưởng mà không mất quyền sở
            hữu.
          </p>
        </div>
      </div>

      <!-- CTA Section -->
      <div class="cta-section">
        <h2>Sẵn sàng bắt đầu?</h2>
        <p>Kết nối ví Sui của bạn để truy cập hệ thống MediChain</p>

        <div class="cta-buttons">
          <button id="connectWalletBtn" class="btn btn-primary btn-large">
            <i class="fas fa-wallet"></i>
            Kết nối Sui Wallet
          </button>

          <button
            class="btn btn-outline btn-large"
            onclick="window.open('https://chrome.google.com/webstore/detail/sui-wallet/opcgpfmipidbgpenhmajoajpbobppdil', '_blank')"
          >
            <i class="fas fa-download"></i>
            Cài đặt Ví
          </button>
        </div>

        <div class="wallet-info">
          <p>
            <i class="fas fa-info-circle"></i>
            Hệ thống đang chạy trên
            <span class="network-badge">Sui Testnet</span>
          </p>
        </div>
      </div>

      <!-- Footer -->
      <footer class="landing-footer">
        <div class="footer-logo">
          <i class="fas fa-shield-heart"></i>
          <span>MediChain</span>
        </div>

        <div class="footer-links">
          <a href="#" target="_blank"><i class="fab fa-github"></i> GitHub</a>
          <a href="#" target="_blank"
            ><i class="fas fa-file-contract"></i> Điều khoản</a
          >
          <a href="#" target="_blank"
            ><i class="fas fa-shield-alt"></i> Bảo mật</a
          >
          <a href="#" target="_blank"
            ><i class="fas fa-question-circle"></i> Trợ giúp</a
          >
        </div>

        <p class="copyright">
          © 2024 MediChain. Tất cả các quyền được bảo lưu.
        </p>
      </footer>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none">
      <div class="spinner"></div>
      <p class="loading-text">Đang kết nối ví...</p>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="modal-overlay" style="display: none">
      <div class="modal">
        <div class="modal-header">
          <h3>
            <i class="fas fa-check-circle text-success"></i> Kết nối thành công!
          </h3>
          <button class="modal-close" onclick="closeModal('successModal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <p>
            Ví của bạn đã được kết nối thành công. Đang chuyển hướng đến
            Dashboard...
          </p>
          <div id="walletInfo" class="mt-3 p-3 bg-light rounded">
            <p><strong>Địa chỉ ví:</strong> <span id="walletAddress"></span></p>
            <p>
              <strong>Mạng:</strong>
              <span class="badge badge-primary">Sui Testnet</span>
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Error Modal (with Install Link) -->
    <div id="walletErrorModal" class="modal-overlay" style="display: none">
      <div class="modal">
        <div class="modal-header">
          <h3>
            <i class="fas fa-exclamation-circle text-danger"></i> Lỗi kết nối
          </h3>
          <button class="modal-close" onclick="closeModal('walletErrorModal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <p id="walletErrorMessage">
            Đã xảy ra lỗi khi kết nối ví. Vui lòng thử lại.
          </p>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="closeModal('walletErrorModal')"
          >
            Đóng
          </button>
          <button class="btn btn-primary" onclick="retryConnection()">
            Thử lại
          </button>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="/frontend/js/config.js"></script>
    <script src="/frontend/js/wallet.js"></script>

    <script>
      // Helper function to close modal
      function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
      }

      // Helper function to show modal
      function showModal(modalId) {
        document.getElementById(modalId).style.display = "flex";
      }

      // Retry connection function
      function retryConnection() {
        closeModal("walletErrorModal");
        document.getElementById("connectWalletBtn").click();
      }

      // Connect Wallet Button Handler
      document
        .getElementById("connectWalletBtn")
        .addEventListener("click", async function () {
          const overlay = document.getElementById("loadingOverlay");
          const btn = this;

          // Disable button and show loading
          btn.disabled = true;
          overlay.style.display = "flex";

          try {
            // Use the wallet API from wallet.js
            const connected = await window.walletAPI.connectWallet();

            if (connected) {
              // Get wallet address
              const address = await window.walletAPI.getWalletAddress();

              if (address) {
                // Show success modal
                showModal("successModal");
                document.getElementById("walletAddress").textContent =
                  window.walletAPI.formatWalletAddress(address);

                // Redirect to dashboard after 2 seconds
                setTimeout(() => {
                  window.location.href = "dashboard.html";
                }, 2000);
              } else {
                throw new Error("Không thể lấy địa chỉ ví");
              }
            }
          } catch (error) {
            console.error("Connection error:", error);

            // Error is already shown by wallet.js showWalletInstallModal()
            // But we can add additional handling here if needed
            if (!window.walletAPI.isWalletInstalled()) {
              // Modal already shown by wallet.js
            } else {
              // Show generic error modal
              showModal("walletErrorModal");
              document.getElementById("walletErrorMessage").textContent =
                error.message ||
                "Đã xảy ra lỗi khi kết nối ví. Vui lòng thử lại.";
            }
          } finally {
            overlay.style.display = "none";
            btn.disabled = false;
          }
        });

      // Check if already connected on page load
      window.addEventListener("load", async function () {
        try {
          // Check if wallet is connected
          const isConnected = await window.walletAPI.isWalletConnected();

          if (isConnected) {
            const address = await window.walletAPI.getWalletAddress();
            console.log("Already connected to wallet:", address);

            // Show a brief notification
            const overlay = document.getElementById("loadingOverlay");
            const loadingText = overlay.querySelector(".loading-text");
            loadingText.textContent = "Đã kết nối! Đang chuyển hướng...";
            overlay.style.display = "flex";

            // Auto-redirect to dashboard
            setTimeout(() => {
              window.location.href = "/dashboard.html";
            }, 1000);
          }
        } catch (error) {
          console.error("Error checking wallet connection:", error);
        }
      });

      // Close modals when clicking outside
      document.querySelectorAll(".modal-overlay").forEach((overlay) => {
        overlay.addEventListener("click", function (e) {
          if (e.target === this) {
            this.style.display = "none";
          }
        });
      });

      // Check wallet installation status on page load
      window.addEventListener("load", function () {
        if (!window.walletAPI.isWalletInstalled()) {
          console.warn(
            "Sui Wallet not detected. User will be prompted to install when connecting."
          );
        } else {
          console.log("Sui Wallet detected and ready.");
        }
      });
    </script>
  </body>
</html>
